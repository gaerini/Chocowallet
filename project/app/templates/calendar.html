{% extends 'base.html'%}
{% block css %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'calendar.css' %}">
{% endblock css %}
{% block container %}
{% if user.is_authenticated and user.pk == first_thing.author.pk %}
<div class="momdiv">
    <div class="calendar">
        <div class="line"></div>
        <table class="Calendar">
            <thead>
                <tr id="monthmenubar">
                    <td colspan="5" id="YearMonth">
                        <span id="calYear"></span>ë…„
                        <span id="calMonth"></span>ì›”
                    </td>
                </tr>
                <tr id="weekday">
                    <td>ì¼</td>
                    <td>ì›”</td>
                    <td>í™”</td>
                    <td>ìˆ˜</td>
                    <td>ëª©</td>
                    <td>ê¸ˆ</td>
                    <td>í† </td>
                </tr>
            </thead>
            <tbody class="tt">
            </tbody>
        </table>
    </div>
</div>
<div class="momdiv3">
    <div class="option1 hidden6">
        <button id="logout">
            <a href="{% url 'cover' %}" id="ë¡œê·¸ì•„ì›ƒ">
                ë¡œê·¸ì•„ì›ƒ
            </a>
        </button>        
        <button id="userguide">
            <a href="https://typical-spectacles-572.notion.site/2be0f8cc68d94f98bd93e7ca1568e58e?pvs=4">
                <img src="{% static 'onlylogo.png' %}" alt="only logo"/>ì‚¬ìš©ì ê°€ì´ë“œ
            </a>
        </button>
        <button class = "eventmenuclose">
            ğŸ™‰
        </button>
        <button class = "addEventBtn1">
            +
        </button>
    </div>
    <div class="option2">
        <button class = "eventmenuopen">
            ğŸ™ˆ
        </button>
        <button class = "addEventBtn2">
            +
        </button>
    </div>
</div>

<div class="momdiv2">    
    <div class="progress">
        <div class="progressbox"></div>
        <div class="progresspercent"></div> 
    </div>
    <div class="costbox">
        <div class="spent_cost">
            <div class="spent_color"></div>
            <span class="span_cost" id="spent_cost">{{sumForRealSpend}} ì›</span>
            <span class="span">ì˜¤ëŠ˜ê¹Œì§€ ì‹¤ì œ ì´ ì§€ì¶œ ê¸ˆì•¡</span>
        </div>
        <div class="expected_cost">
            <div class="expected_color"></div>
            <span class="span_cost" id="expected_cost"></span>
            <span class="span">ì´ë²ˆ ë‹¬ ì´ ì˜ˆìƒ ì§€ì¶œ ê¸ˆì•¡</span>
        </div>
    </div>
</div>


<div class="modalbox hidden">
    <div class="background"></div>
    <div class="modal">
        <div class="modal_back">
            <div class ="modal_first_bar">
                <button type="button" class="close">í™•ì¸</button>
                <div class="modal_date_day">
                    <p class="modal-date"></p>
                    <span class="modal-day"></span>
                </div>
                <button type="button" class="addEventBtn3" style="color: blue;">ì¶”ê°€</button>
            </div>
            <div class="doit">
                <p>í•  ì¼</p>
            </div>
            <div class="event_modal_content"></div>
            <div class="show_real_spend"></div>
            <form action="http://127.0.0.1:8000/spend/" method="post" class="spend_form">
                {% csrf_token %}
                <div>
                    <input type="number" name="spend" id="real_spend" placeholder="ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡" />
                </div> 
                <div class="hidden3">
                    <input type="number" name="date" value="" id="date_spend"/>
                </div>
                <button type="submit" class="real_spend_submit">
                    ì…ë ¥
                </button>
            </form>
        </div>
    </div>
</div>

<div class="addEventModal hidden2">
    <div class="background"></div>
    <div class="addEventModal">
        <div class="modal_back">
            <form action="" method="post" id="event_form">
                {% csrf_token %}
                <div class ="modal_first_bar">
                    <button type="button" class="close2" style="color: red;">ì·¨ì†Œ</button>
                    <p id="modal_newevent_firstbar">ìƒˆë¡œìš´ ì´ë²¤íŠ¸</p>
                    <button type="submit">ì¶”ê°€</button>
                </div>
                <div class="title_content">
                    <div>
                        <input type="text" name="content" id="event_title" placeholder=" í•  ì¼ "/>
                    </div>
                </div>
                <div class="startdate">
                    <div>
                        <label for="date">ì‹œì‘</label>
                        <input type="date" name="start_date" id="event_date"/>
                    </div>
                    <div>
                        <label for="date">ì¢…ë£Œ</label>
                        <input type="date" name="finish_date" id="event_finish_date"/>
                    </div>
                </div>
                <div class="color">
                    <div>
                        <label for="category">ìƒ‰ìƒ</label>
                        <div class="color-picker">
                            <input type="color" name="category" id="event_category" list="colorOptions" value="#ABE3FF">
                            <datalist id="colorOptions">
                                <option>#abe3ff</option>
                                <option>#FFBBB4<x/option>
                                <option>#C4BEFF</option>
                                <option>#FDD3FF</option>
                                <option>#D8FFCD</option>
                                <option>#FFF1D0</option>
                                <option>#FBFFCD</option>
                                <option>#D0E1FF</option>
                                <option>#FFDCD6</option>
                                <option>#bcffe7</option>
                            </datalist>
                        </div>
                    </div>
                </div>
                <div class="expectspend">
                    <input type="number" name="cost" id="event_cost" placeholder="ì˜ˆìƒ ì§€ì¶œ ê¸ˆì•¡" style="color: gray;"/>
                </div>
                <div>
                    <textarea name="memo" id="event_memo" cols="30" rows="10" placeholder="ë©”ëª¨"></textarea>
                </div>
            </form>
        </div>
    </div>
</div>

{% else %}
<p>ê¶Œí•œ ì—†ìŒ</p>
{% endif %}

<script>
    const modalBox = document.querySelector(".modalbox");
    const openBtn = document.querySelector("tbody");
    const closeBtn = document.querySelector(".close");
    
    const events = [
        {% for event in events %}
            {
                start_date: "{{event.start_date}}",
                finish_date: "{{event.finish_date}}",
                detail: "{{event.content}}",
                cost: {{event.cost}},
                category: "{{event.category}}",
            },
        {%endfor%}
        ];
        const realspends = [
        {% for realspend in realSpends %}
            {
                date: "{{realspend.date}}",
                spend: {{realspend.spend}},
            },
        {% endfor %}
    ];

    firstLanding();

    //ìˆ˜ì •ì°½ì—ì„œ ë’¤ë¡œê°€ê¸° ëˆ„ë¥´ë©´ ëª¨ë‹¬ì°½ ê·¸ëŒ€ë¡œ ë– ìˆê²Œ
    function firstLanding() {
        const key = window.localStorage.getItem("modal")

        if (key) {
            const modalDate = document.querySelector(".modal-date");
            modalDate.innerHTML = key
            month_ = key.split("-");
            const modalBox = document.querySelector('.modalbox')
            modalBox.classList.remove("hidden")
            
            makeModal(month_);
        }
    }
    
    //
    function showEvent () {
        const key = window.localStorage.getItem("modal")
        let month_ = ''
        
        if (!key) {
            const month_for_choice = document.querySelector(".modal-date").innerText; //"modal-date" divì˜ innertextë¥¼ ê°€ì ¸ì˜´
            const modal_day = document.querySelector(".modal-day").innerText; //ëª¨ë‹¬ì°½ì˜ ìš”ì¼
            month_ = month_for_choice.split('-');  // í•˜ì´í”ˆì„ ê¸°ì¤€ìœ¼ë¡œ ëŠì–´ì„œ ë°°ì—´ë¡œ ì €ì¥ (["2023","12","23"])

            window.localStorage.setItem("modal", month_for_choice);
            window.localStorage.setItem("modalDay", modal_day);
        } else {
            month_ = key.split("-")

        }
        makeModal(month_)
    }
    

    function makeModal(month_) {
        let events_lists = JSON.parse('{{ events_list|escapejs }}');
        let event_modal_content = document.querySelector('.event_modal_content');
        let expectedCost = 0

        for (let i = 1; i < events.length; i++) {
            let s_year = (new Date (events_lists[i]['start_date'])).getFullYear();
            let f_year = (new Date(events_lists[i]['finish_date'])).getFullYear();
            let s_month = (new Date (events_lists[i]['start_date'])).getMonth()+1; //ë‚´ê°€ ì‘ì„±í•œ ì¼ì •ì˜ ì‹œì‘ month
            let f_month = (new Date (events_lists[i]['finish_date'])).getMonth()+1;
            let s_day = (new Date (events_lists[i]['start_date'])).getDate(); //ë‚´ê°€ ì‘ì„±í•œ ì¼ì •ì˜ ì‹œì‘ ë‚ ì§œ
            let f_day = (new Date(events_lists[i]['finish_date'])).getDate();

            if (s_year <= Number(month_[0]) && Number(month_[0]) <= f_year ) {
                if (s_month <= Number(month_[1]) && Number(month_[1]) <= f_month ) {
                    if (s_day <= Number(month_[2]) && Number(month_[2]) <= f_day) {
                        let div_ = document.createElement('div'); // modalì— event ì´ë¦„, ê¸ˆì•¡, ì‚­ì œ ë²„íŠ¼ ê°ì‹¸ëŠ” div tag
                        let div_2 = document.createElement('div');
                        let span_ = document.createElement('span');
                        let aForEdit = document.createElement('a');

                        span_.innerText = events_lists[i].content;
                        expectedCost += events_lists[i].cost;

                        //ì´ë²¤íŠ¸ ìˆ˜ì •
                        aForEdit.href = "/edit/" + events_lists[i].event_pk + "/";
                        aForEdit.classList.add(`${events_lists[i].event_pk}`);
                        aForEdit.classList.add("aForEdit");

                        aForEdit.appendChild(div_2);
                        div_.appendChild(aForEdit);
                        div_2.appendChild(span_);
                        
                        event_modal_content.appendChild(div_);
                        span_.classList.add("todoEvent");
                    }
                }
            }
        }

        //ì‹¤ì œ ì§€ì¶œì•¡ ì¹¸ ëˆ„ë¥´ë©´ date_spend ì— ì €ì ˆë¡œ ë‚ ì§œ ê°’ì´ ë“¤ì–´ê°€ê²Œ (finish_date == list)
        // -> filldateí•¨ìˆ˜ë¥¼ ì—¬ê¸°ë¡œ ì˜®ê¹€
        // const date_for_choice = document.querySelector(".modal-date").innerText; //"modal-date" divì˜ innertextë¥¼ ê°€ì ¸ì˜´
        // const date_ = date_for_choice.split("-");
        const date_ = month_;
        const spendYear = date_[0];
        const spendMonth = date_[1].padStart(2, "0");
        const spendDate = date_[2].padStart(2, "0");
        const spend_date = spendYear + spendMonth + spendDate;

        const spendDateInputBox = document.querySelector("#date_spend");
        spendDateInputBox.value = spend_date;
    

        // ëª¨ë‹¬ì— ê·¸ë‚ ì˜ ì‹¤ì œ ì§€ì¶œì•¡ ë³´ì—¬ì£¼ê¸°
        // ë‚´ê°€ ëˆ„ë¥¸ ë‚ ì§œ ë°›ì•„ì˜¤ê¸°
        const clickyear = Number(month_[0]);
        const clickmonth = Number(month_[1]);
        const clickdt = Number(month_[2]);
        // ì‹¤ì œ ì§€ì¶œì•¡ ì ì„ ëª¨ë‹¬
        const show_real_spend = document.querySelector(".show_real_spend");
        let spends_lists = JSON.parse('{{ spends_list|escapejs }}');
        let countSpend = JSON.parse('{{ spendCount|escapejs }}');
    
        for (i = 0; i < countSpend; i++) {
            const str_spenddate = String(spends_lists[i].date);
            // console.log(Number(str_spenddate.substring(0,4)), typeof(Number(str_spenddate.substring(0,4))));

            //í•´ë‹¹ ë‚ ì˜ ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ì„ ì ì€ ê²½ìš°
            if (Number(str_spenddate.substring(0,4)) == clickyear && Number(str_spenddate.substring(4,6) == clickmonth && Number(str_spenddate.substring(6,8))) == clickdt) {
            
               
                let divBox = document.createElement('div');
                divBox.classList.add("divBox"); //í´ë˜ìŠ¤ëª…
                
                //ì´ë²¤íŠ¸ ëª¨ë‹¬ì—ì„œ ê¸ˆì•¡ ì´ë¦„ ë¶€ë¶„
                let divForTitle = document.createElement('div');
                divForTitle.classList.add("divForTitle");
                let spanForExpected = document.createElement('span');
                spanForExpected.innerText = "ì´ ì˜ˆìƒ ì§€ì¶œ ê¸ˆì•¡";
                let spanForSpend = document.createElement('span');
                spanForSpend.innerText = "ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡";

                divBox.appendChild(divForTitle);
                divForTitle.appendChild(spanForExpected);
                divForTitle.appendChild(spanForSpend);

                //ì´ë²¤íŠ¸ ëª¨ë‹¬ì—ì„œ ê¸ˆì•¡ ë¶€ë¶„
                let divForCost = document.createElement('div');
                divForCost.classList.add("divForCost");
                let spanForExpectedCost = document.createElement('span');
                spanForExpectedCost.innerText = (expectedCost).toLocaleString();
                let spanForSpendCost = document.createElement('span');

                //ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡
                let spendInInt = (spends_lists[i].spend).toLocaleString();
                //console.log(spendInInt, typeof(spendInInt));
                spanForSpendCost.innerText = spendInInt;

                divBox.appendChild(divForCost);
                divForCost.appendChild(spanForExpectedCost);
                divForCost.appendChild(spanForSpendCost);

                //ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ ì‚­ì œ ë²„íŠ¼
                let aForSpendEdit = document.createElement('a');
                aForSpendEdit.innerText = 'ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ ìˆ˜ì •/ì‚­ì œ';
                aForSpendEdit.href = "/delete-spend/" + spends_lists[i].spend_pk + "/";
                divBox.appendChild(aForSpendEdit);
                
                show_real_spend.appendChild(divBox);
                
                //ì‹¤ì œì§€ì¶œì•¡ ì‘ì„± í¼ ì—†ì• ê¸°
                const spendForm = document.querySelector(".spend_form");
                spendForm.classList.add("hidden4");

                 //divBoxForZero ì—†ì• ê¸°
                 (document.querySelector(".divBoxForZero")).classList.add("hidden");

            }

            //ì‹¤ì œì§€ì¶œê¸ˆì•¡ì„ ì ì§€ ì•Šì€ ê²½ìš°
            else {
                const divBoxForZero = document.querySelector(".divBoxForZero");

                if (!divBoxForZero) { //divê°€ ì—¬ëŸ¬ë²ˆ ìƒê¸°ëŠ” ê±¸ ë°©ì§€í•˜ê¸° ìœ„í•¨
                    let divBox = document.createElement('div');
                    divBox.classList.add("divBoxForZero"); //ìœ„ ì½”ë“œì—ì„œ div classëª…ë§Œ ë°”ê¿ˆ
                    
                    //ì´ë²¤íŠ¸ ëª¨ë‹¬ì—ì„œ ê¸ˆì•¡ ì´ë¦„ ë¶€ë¶„
                    let divForTitle = document.createElement('div');
                    divForTitle.classList.add("divForTitle");
                    let spanForExpected = document.createElement('span');
                    spanForExpected.innerText = "ì´ ì˜ˆìƒ ì§€ì¶œ ê¸ˆì•¡";
                    let spanForSpend = document.createElement('span');
                    spanForSpend.innerText = "ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡";

                    divBox.appendChild(divForTitle);
                    divForTitle.appendChild(spanForExpected);
                    divForTitle.appendChild(spanForSpend);

                    //ì´ë²¤íŠ¸ ëª¨ë‹¬ì—ì„œ ê¸ˆì•¡ ë¶€ë¶„
                    let divForCost = document.createElement('div');
                    divForCost.classList.add("divForCost");
                    let spanForExpectedCost = document.createElement('span');
                    spanForExpectedCost.innerText = (expectedCost).toLocaleString();
                    let spanForSpendCost = document.createElement('span');

                    //ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ì„ 0ìœ¼ë¡œ í‘œì‹œ
                    let spendInInt = 0;
                    //console.log(spendInInt, typeof(spendInInt));
                    spanForSpendCost.innerText = spendInInt;

                    divBox.appendChild(divForCost);
                    divForCost.appendChild(spanForExpectedCost);
                    divForCost.appendChild(spanForSpendCost);
                    
                    show_real_spend.appendChild(divBox);
                }
            }
        }
    }

    const menu1 = document.querySelector('.eventmenuopen');
    const menu2 = document.querySelector('.eventmenuclose');
    const option1 = document.querySelector('.option1');
    const option2 = document.querySelector('.option2');
    
    
    menu1.addEventListener('click', function() {
        option1.classList.remove('hidden6');
        option2.classList.add('hidden7');
    });

    menu2.addEventListener('click', function() {
        option2.classList.remove('hidden7');
        option1.classList.add('hidden6');
    });

    const dateInput = document.getElementById('event_date');
    
    dateInput.addEventListener('click', () => {
      dateInput.focus();
    });

    const eventCategoryInput = document.getElementById('event_category');
    const eventTitleInput = document.getElementById('event_title');
    const eventCost = document.getElementById('event_cost');
    const eventMemo = document.getElementById('event_memo');

    eventCategoryInput.addEventListener("input", function () {
        const selectedColor = eventCategoryInput.value;
        Input.style.borderLeftColor = selectedColor;
        eventCost.style.borderLeftColor = selectedColor;
        eventMemo.style.borderLeftColor = selectedColor;
    });

</script>
<script src="{% static 'js/calendar.js' %}"></script>
<script src="{% static 'js/modal.js' %}"></script>
<script src="{% static 'js/touchMove.js' %}"></script>
{% endblock container %}