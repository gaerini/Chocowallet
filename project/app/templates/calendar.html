{% extends 'base.html'%}

{% block css %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'calendar.css' %}">
{% endblock css %}

{% block container %}

{% if user.is_authenticated and user.pk == first_thing.author.pk %}
<div class="momdiv">
    <div class="button">
        <a href="{% url 'logout' %}" id="로그아웃">로그아웃</a>
    </div>
    <div class="calendar">
        <div class="line"></div>
        <table class="Calendar">
            <thead>
                <tr id="monthmenubar">
                    <td colspan="5" id="YearMonth">
                        <span id="calYear"></span>년
                        <span id="calMonth"></span>월
                    </td>
                </tr>
                <tr id="weekday">
                    <td>일</td>
                    <td>월</td>
                    <td>화</td>
                    <td>수</td>
                    <td>목</td>
                    <td>금</td>
                    <td>토</td>
                </tr>
            </thead>

            <tbody class="tt">
            </tbody>
        </table>
    </div>
    <div class="modalbox hidden">
        <div class="background"></div>
        <div class="modal">
            <div class="modal-date"></div>
            <div class="event_modal">
                <div class="event_modal_content"></div>
                <div class="spendFormAndShow">
                    <div class="show_real_spend"></div>
                    <form action="http://127.0.0.1:8000/spend/" method="post" class="spend_form">
                        {% csrf_token %}
                        <div>
                            <label for="spend">실제지출액</label>
                            <input type="number" name="spend" id="real_spend" placeholder="실제로 지출한 금액을 적어주세요"/>
                        </div>
                        <div class="hidden3">
                            <input type="number" name="date" value="" id="date_spend"/>
                        </div>
                        <button type="submit" class="real_spend_submit">작성하기</button>
                    </form>
                </div>
                <button class="close">
                    X
                </button>
            </div>
        </div>
    </div>

    <div class="addEventModal hidden2">
        <form action="" method="post">
            {% csrf_token %}
            <div>
                <label for="date">시작날짜</label>
                <input type="date" name="start_date" id="event_date"/>
            </div>
            <div>
                <label for="date">끝 날짜</label>
                <input type="date" name="finish_date" id="event_finist_date"/>
            </div>
            <div>
                <label for="content">내용</label>
                <input type="text" name="content" id="event_content" placeholder="이벤트를 입력해주세요"/>
            </div>
            <div>
                <label for="cost">금액</label>
                <input type="number" name="cost" id="event_cost" placeholder="예상 지출 금액을 입력해주세요"/>
            </div>
            <div>
                <label for="category">색상</label>
                <input type="color" name="category" id="event_category" list="colorOptions">
                <datalist id="colorOptions">
                    <option>#ABE3FF</option>
                    <option>#FFBBB4</option>
                    <option>#C4BEFF</option>
                    <option>#FDD3FF</option>
                    <option>#D8FFCD</option>
                    <option>#FFF1D0</option>
                    <option>#FBFFCD</option>
                    <option>#D0E1FF</option>
                    <option>#FFDCD6</option>
                    <option>#E5E8BA</option>
                </datalist>
            </div>
            <button type="submit">
                작성하기
            </button>
        </form>
        <button class="close2">
            X
        </button>
    </div>
</div>

<div class="momdiv2">    
    <div class="progress">
        <div class="progressbox"></div>
        <div class="progresspercent"></div> 
    </div>
    <div class="costbox">
        <div class="spent_cost">
            <div class="spent_color"></div>
            <span class="span_cost" id="spent_cost">{{sumForRealSpend}} 원</span>
            <span class="span">오늘까지 실제 총 지출 금액</span>
        </div>
        <div class="expected_cost">
            <div class="expected_color"></div>
            <span class="span_cost" id="expected_cost"></span>
            <span class="span">이번 달 총 예상 지출 금액</span>
        </div>
    </div>

    <!--이벤트 수정-->
    <div class="eventEditModal hidden5">
        <form action="http://127.0.0.1:8000/edit/" method="post">
            {% csrf_token %}
            <div>
                <label for="date">시작날짜</label>
                <input type="date" name="start_date" id="event_date_update"/>
            </div>
            <div>
                <label for="date">끝 날짜</label>
                <input type="date" name="finish_date" id="event_finist_date_update"/>
            </div>
            <div>
                <label for="content">내용</label>
                <input type="text" name="content" id="event_content_update" value=""/>
            </div>
            <div>
                <label for="cost">금액</label>
                <input type="number" name="cost" id="event_cost_update" value=""/>
            </div>
            <div>
                <label for="category">색상</label>
                <input type="color" name="category" id="event_category_update" list="colorOptions">
                <datalist id="colorOptions">
                    <option>#ABE3FF</option>
                    <option>#FFBBB4</option>
                    <option>#C4BEFF</option>
                    <option>#FDD3FF</option>
                    <option>#D8FFCD</option>
                    <option>#FFF1D0</option>
                    <option>#FBFFCD</option>
                    <option>#D0E1FF</option>
                    <option>#FFDCD6</option>
                    <option>#E5E8BA</option>
                </datalist>
            </div>
            <button type="submit">
                작성하기
            </button>
        </form>
        <button class="close3">
            X
        </button>
    </div> 
</div>

<div class="momdiv3">
    <button class = "addEvent">
        일정 추가하기
    </button>
</div>
{% else %}
<p>권한 없음</p>
{% endif %}

<script>
    const modalBox = document.querySelector(".modalbox");
    const openBtn = document.querySelector("tbody");
    const closeBtn = document.querySelector(".close");

    const modal2 = document.querySelector(".addEventModal");
    const openBtn2 = document.querySelector(".addEvent");
    const closeBtn2 = document.querySelector(".close2");

    const events = [
    {% for event in events %}
        {
            start_date: "{{event.start_date}}",
            finish_date: "{{event.finish_date}}",
            detail: "{{event.content}}",
            cost: {{event.cost}},
            category: "{{event.category}}",
        },
    {%endfor%}
    ];

    const realspends = [
    {% for realspend in realSpends %}
        {
            date: "{{realspend.date}}",
            spend: {{realspend.spend}},
        },
    {% endfor %}
    ];
        

        // 날짜 선택
        function choiceDate(newDIV) {
            if (document.getElementsByClassName("choiceDay")[0]) {                              // 기존에 선택한 날짜가 있으면
                document.getElementsByClassName("choiceDay")[0].classList.remove("choiceDay");  // 해당 날짜의 "choiceDay" class 제거
            }
            newDIV.classList.add("choiceDay");           // 선택된 날짜에 "choiceDay" class 추가
        }



        // 이전달 버튼 클릭
        function prevCalendar() {
            nowMonth = new Date(nowMonth.getFullYear(), nowMonth.getMonth() - 1, nowMonth.getDate());   // 현재 달을 1 감소
            buildCalendar();    // 달력 다시 생성
        }
        // 다음달 버튼 클릭
        const emc = document.querySelector(".event_modal_content");
        function nextCalendar() {
            nowMonth = new Date(nowMonth.getFullYear(), nowMonth.getMonth() + 1, nowMonth.getDate());   // 현재 달을 1 증가
            buildCalendar();    // 달력 다시 생성
            emc.innerHTML = '';
        }

        // input값이 한자리 숫자인 경우 앞에 '0' 붙혀주는 함수
        function leftPad(value) {
            if (value < 10) {
                value = "0" + value;
                return value;
            }
            return value;
        }

    var saveMonth;
    var saveDate;
    

    {% comment %} function openModal(event, newDIV) {
        //console.log(newDIV.innerHTML);
        modalDate.innerHTML = `${modal_Month}월 ${modal_Date}일`;
        modalBox.classList.remove("hidden");
        
        return "Fuck you";
    } {% endcomment %}


    //모달 여닫기

    const e_m_c = document.querySelector(".event_modal_content"); //모달 내용 비우기
    const s_r_s = document.querySelector(".show_real_spend");
    function closeModal() {
      modalBox.classList.add("hidden");
      e_m_c.innerHTML = '';
      s_r_s.innerHTML = '';
      spendForm.classList.remove("hidden4");
    }

    closeBtn.addEventListener("click", closeModal);

    //모달 내부
    function openAddEventModal() {
      modal2.classList.remove("hidden2");
    }

    function closeAddEventModal() {
      modal2.classList.add("hidden2");
    }

    openBtn2.addEventListener("click", openAddEventModal);
    closeBtn2.addEventListener("click", closeAddEventModal);
    //요까지

    const date = document.querySelector(".choiceDay");
    const submitEvent = document.querySelector(".close2");

    window.onload = function () { buildCalendar(); }

    
    //모달 창 열면 그날에 해당하는 이벤트(+예상 지출 금액)만 보여주기!!!!!!!!
    const tbody_ = document.querySelector(".tt");
    const spendForm = document.querySelector(".spend_form");
             
    function showEvent () {
    const month_for_choice = document.querySelector(".modal-date").innerText; //"modal-date" div의 innertext를 가져옴
    const month_ = month_for_choice.split('-');  // 하이픈을 기준으로 끊어서 배열로 저장 (["2023","12","23"])
                
    let events_lists = JSON.parse('{{ events_list|escapejs }}');
    let event_modal_content = document.querySelector('.event_modal_content');
    
    for (let i = 1; i < events.length; i++) {
        let s_month = (new Date (events_lists[i]['start_date'])).getMonth()+1; //내가 작성한 일정의 시작 month
        let f_month = (new Date (events_lists[i]['finish_date'])).getMonth()+1;
    
        let s_day = (new Date (events_lists[i]['start_date'])).getDate(); //내가 작성한 일정의 시작 날짜
        let f_day = (new Date(events_lists[i]['finish_date'])).getDate();
    
        if (s_month <= Number(month_[1]) && Number(month_[1]) <= f_month ) {
            if (s_day <= Number(month_[2]) && Number(month_[2]) <= f_day) {
                let p_ = document.createElement('p');
                let span_ = document.createElement('span');
                let p__ = document.createElement('p');

                span_.innerText = events_lists[i].content;
                p__.innerText = "예상 지출 금액: " + events_lists[i].cost;

                p_.appendChild(span_);
                span_.appendChild(p__);
                event_modal_content.appendChild(p_);
                p_.classList.add([i]);
                span_.classList.add("todoEvent");
            }
        }
    }

            if (s_month <= Number(month_[1]) && Number(month_[1]) <= f_month ) {
                if (s_day <= Number(month_[2]) && Number(month_[2]) <= f_day) {
                    let p_ = document.createElement('p');
                    let span_ = document.createElement('span');
                    let p__ = document.createElement('p');
    
                    span_.innerText = events_lists[i].content;
                    p__.innerText = "예상 지출 금액: " + events_lists[i].cost;
    
                    p_.appendChild(span_);
                    span_.appendChild(p__);
                    event_modal_content.appendChild(p_);
                    p_.classList.add([i]);
                    span_.classList.add("todoEvent");
                }
            }
        }
    
    
    //모달에 그날의 실제 지출액 보여주기
     // 내가 누른 날짜 받아오기
    const clickyear = Number(month_[0]);
    const clickmonth = Number(month_[1]);
    const clickdt = Number(month_[2]);
   
    // 실제 지출액 적을 모달
    const show_real_spend = document.querySelector(".show_real_spend");

    let spends_lists = JSON.parse('{{ spends_list|escapejs }}');
    let countSpend = JSON.parse('{{ spendCount|escapejs }}');

    for (i = 0; i < countSpend; i++) {
        const str_spenddate = String(spends_lists[i].date);
        console.log(Number(str_spenddate.substring(0,4)), typeof(Number(str_spenddate.substring(0,4))));
        if (Number(str_spenddate.substring(0,4)) == clickyear && Number(str_spenddate.substring(4,6) == clickmonth && Number(str_spenddate.substring(6,8))) == clickdt) {
            let pForSpend = document.createElement('p');
            pForSpend.classList.add("pForSpend");
            let spanForSpend = document.createElement('span');

            spanForSpend.innerText = "실제 지출 금액: "+spends_lists[i].spend;
            pForSpend.appendChild(spanForSpend);
            show_real_spend.appendChild(pForSpend);

            //실제지출액 작성 폼 없애기
            spendForm.classList.add("hidden4");
        }
    }


    tbody_.addEventListener("click", showEvent);

    //실제 지출액 칸 누르면 date_spend 에 저절로 날짜 값이 들어가게 (finish_date == list)
    const realSpend = document.querySelector("#real_spend");
    
    function fillDate() {
        const date_for_choice = document.querySelector(".modal-date").innerText; //"modal-date" div의 innertext를 가져옴
        const date_ = date_for_choice.split('-');

        const spendYear = date_[0];
        const spendMonth = date_[1].padStart(2, '0');
        const spendDate = date_[2].padStart(2, '0');
        const spend_date = spendYear+spendMonth+spendDate;

        const spendDateInputBox = document.querySelector("#date_spend");
        spendDateInputBox.value = spend_date;
    }

    realSpend.addEventListener("click", fillDate)    

    //모달에서 이벤트 누르면 수정할 수 있게 하는 코드 (p태그의 클래스 = event의 pk값)
    const todoEvent = document.querySelector(".todoEvent");
    const eventEditModal = document.querySelector(".eventEditModal");

    function edit() {
        for (let i = 1; i < events.length; i++) {
            let updateEventPk = getElementsByClassName("{{i}}");
            
        }
    }

    //todoEvent.addEventListener("click",edit);

</script>
<script src="{% static 'js/touchMove.js' %}"></script>
<script src="{% static 'js/eventSum.js' %}"></script>
{% endblock container %}
